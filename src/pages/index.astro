---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import CastleSceneRetro from '../components/CastleSceneRetro.astro';
import Base from '../layouts/Base.astro';
import { fetchYouTubeTalks } from '../utils/youtube';

// Unified content item for the feed
interface FeedItem {
	title: string;
	url: string;
	date: Date;
	source: string;
	icon: string;
	description: string;
}

// Get latest blog posts
const blogPosts = await getCollection('blog', ({ data }: CollectionEntry<'blog'>) => {
	return data.draft !== true;
});
const latestBlogPosts: FeedItem[] = blogPosts
	.sort(
		(a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) =>
			b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
	)
	.slice(0, 3)
	.map((post: CollectionEntry<'blog'>) => ({
		title: post.data.title,
		url: `/blog/${post.slug}/`,
		date: post.data.pubDate,
		source: 'Library',
		icon: 'üìö',
		description: post.data.description,
	}));

// Get latest talks (manual + YouTube)
const manualTalks = await getCollection('talks');
const youtubeTalks = await fetchYouTubeTalks();

const allTalks = [
	...manualTalks.map((talk: CollectionEntry<'talks'>) => ({
		title: talk.data.title,
		url: `/talks/#${talk.id}`,
		date: talk.data.date,
		source: 'Tower',
		icon: 'üè∞',
		description: talk.data.summary,
	})),
	...youtubeTalks.map((talk, index) => ({
		title: talk.title,
		url: `/talks/#youtube-${index}`,
		date: talk.date,
		source: 'Tower',
		icon: 'üè∞',
		description: talk.summary,
	})),
];

const latestTalks = allTalks.sort((a, b) => b.date.valueOf() - a.date.valueOf()).slice(0, 3);

// Get latest projects
const projects = await getCollection('projects');
const latestProjects: FeedItem[] = projects
	.filter((p: CollectionEntry<'projects'>) => p.data.firstPublic !== undefined)
	.sort((a: CollectionEntry<'projects'>, b: CollectionEntry<'projects'>) => {
		if (!a.data.firstPublic && !b.data.firstPublic) return 0;
		if (!a.data.firstPublic) return 1;
		if (!b.data.firstPublic) return -1;
		return b.data.firstPublic.valueOf() - a.data.firstPublic.valueOf();
	})
	.slice(0, 2)
	.map((project: CollectionEntry<'projects'>) => ({
		title: project.data.name,
		url: `/forge/#${project.id}`,
		date: project.data.firstPublic || new Date(),
		source: 'Forge',
		icon: '‚öíÔ∏è',
		description: project.data.description,
	}));

// Combine and sort all content by date
const latestContent = [...latestBlogPosts, ...latestTalks, ...latestProjects]
	.sort((a, b) => b.date.valueOf() - a.date.valueOf())
	.slice(0, 6);
---

<Base title="Securing the Realm - Castle Gate">
  <div class="container" style="padding: var(--space-16) var(--space-4);">
    <section style="text-align: center; margin-bottom: var(--space-16);">
      <h1 style="margin-bottom: var(--space-8);">Welcome to the Castle</h1>
      <p
        style="font-size: var(--font-size-lg); max-width: 800px; margin: 0 auto var(--space-8) auto;"
      >
        Embark on a journey where technology meets adventure. Through epic
        storytelling and engaging demos, we transform complex cybersecurity and
        AI topics into adventurous quests.
      </p>
    </section>

    <section style="margin-bottom: var(--space-16);">
      <!-- Interactive Castle Scene -->
      <div style="max-width: 1200px; margin: 0 auto var(--space-12) auto;">
        <CastleSceneRetro />
      </div>

      <!-- Text-based Navigation Fallback -->
      <h2 style="text-align: center; margin-bottom: var(--space-8);">
        Explore the Realm
      </h2>
      <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-6);"
      >
        <!-- Tower - Talks -->
        <a
          href="/talks/"
          class="realm-card glow-on-hover"
          style="padding: var(--space-6); background: var(--colour-teal-dark); border: 2px solid var(--colour-gold); border-radius: var(--radius-outer); text-align: center; display: block; transition: transform var(--transition-base);"
        >
          <h3
            style="font-size: var(--font-size-xl); margin-bottom: var(--space-4);"
          >
            üè∞ Tower
          </h3>
          <p style="margin: 0; color: var(--colour-parchment);">
            Watch talks and presentations on Azure, AI, and cybersecurity
          </p>
        </a>

        <!-- Library - Blog -->
        <a
          href="/blog/"
          class="realm-card glow-on-hover"
          style="padding: var(--space-6); background: var(--colour-teal-dark); border: 2px solid var(--colour-gold); border-radius: var(--radius-outer); text-align: center; display: block; transition: transform var(--transition-base);"
        >
          <h3
            style="font-size: var(--font-size-xl); margin-bottom: var(--space-4);"
          >
            üìö Library
          </h3>
          <p style="margin: 0; color: var(--colour-parchment);">
            Read articles and insights on technology and security
          </p>
        </a>

        <!-- Forge - Projects -->
        <a
          href="/forge/"
          class="realm-card glow-on-hover"
          style="padding: var(--space-6); background: var(--colour-teal-dark); border: 2px solid var(--colour-gold); border-radius: var(--radius-outer); text-align: center; display: block; transition: transform var(--transition-base);"
        >
          <h3
            style="font-size: var(--font-size-xl); margin-bottom: var(--space-4);"
          >
            ‚öíÔ∏è Forge
          </h3>
          <p style="margin: 0; color: var(--colour-parchment);">
            Explore code projects and open-source contributions
          </p>
        </a>

        <!-- Newsletter - Scrolls -->
        <a
          href="/newsletter/"
          class="realm-card glow-on-hover"
          style="padding: var(--space-6); background: var(--colour-teal-dark); border: 2px solid var(--colour-gold); border-radius: var(--radius-outer); text-align: center; display: block; transition: transform var(--transition-base);"
        >
          <h3
            style="font-size: var(--font-size-xl); margin-bottom: var(--space-4);"
          >
            üìú Arcane Scrolls
          </h3>
          <p style="margin: 0; color: var(--colour-parchment);">
            Subscribe to receive updates and insights
          </p>
        </a>
      </div>
    </section>

    <!-- Latest Content Feed -->
    <section style="max-width: 900px; margin: 0 auto var(--space-16) auto;">
      <h2 style="text-align: center; margin-bottom: var(--space-8);">
        Latest Adventures
      </h2>
      <div style="display: flex; flex-direction: column; gap: var(--space-4);">
        {
          latestContent.map((item) => (
            <a
              href={item.url}
              style="display: block; padding: var(--space-4); background: var(--colour-teal-dark); border: 2px solid var(--colour-gold); border-radius: var(--radius-outer); transition: transform var(--transition-base); text-decoration: none;"
              class="feed-item"
            >
              <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                <div style="flex-shrink: 0; font-size: var(--font-size-2xl);">
                  {item.icon}
                </div>
                <div style="flex: 1; min-width: 0;">
                  <div style="display: flex; align-items: baseline; gap: var(--space-2); margin-bottom: var(--space-2); flex-wrap: wrap;">
                    <h3 style="margin: 0; font-size: var(--font-size-lg); color: var(--colour-gold);">
                      {item.title}
                    </h3>
                    <span style="font-size: var(--font-size-xs); color: var(--colour-stone-light); white-space: nowrap;">
                      {item.source}
                    </span>
                  </div>
                  <p style="margin: 0; color: var(--colour-parchment); font-size: var(--font-size-sm); line-height: var(--line-height-relaxed);">
                    {item.description.length > 150
                      ? `${item.description.substring(0, 147)}...`
                      : item.description}
                  </p>
                  <p style="margin-top: var(--space-2); margin-bottom: 0; font-size: var(--font-size-xs); color: var(--colour-stone-light);">
                    {item.date.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                    })}
                  </p>
                </div>
              </div>
            </a>
          ))
        }
      </div>
    </section>

    <section style="max-width: 800px; margin: 0 auto; text-align: center;">
      <h2 style="margin-bottom: var(--space-6);">Our Quest</h2>
      <p
        style="font-size: var(--font-size-lg); line-height: var(--line-height-relaxed);"
      >
        Through epic storytelling and engaging demos, we transform complex
        topics like deploying Large-Language Models (LLMs), Small-Language
        Models (SLMs), and Agentic AI into adventurous quests. Whether you're a
        seasoned tech adventurer or a curious newcomer, you'll gain insights
        into Azure's cutting-edge capabilities, responsible AI practices, and
        open-source projects‚Äîall while battling kobolds, training AI elves, and
        unlocking the secrets of the Crystal Keep.
      </p>
      <a
        href="/about/"
        style="display: inline-block; margin-top: var(--space-6); padding: var(--space-3) var(--space-6); background: var(--colour-gold); color: var(--colour-ink); border-radius: var(--radius-outer); font-weight: var(--font-weight-bold);"
      >
        Learn More About Our Mission
      </a>
    </section>
  </div>
</Base>

<style>
  .realm-card:hover {
    transform: translateY(-4px);
  }

  .feed-item:hover {
    transform: translateX(4px);
  }

  @media (prefers-reduced-motion: reduce) {
    .realm-card:hover,
    .feed-item:hover {
      transform: none;
    }
  }
</style>
